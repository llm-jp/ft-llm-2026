Bootstrap: docker
From: ghcr.io/astral-sh/uv:python3.12-bookworm-slim
Stage: builder

%setup
    mkdir ${SINGULARITY_ROOTFS}/app
    rsync -av --exclude-from=.dockerignore ./ ${SINGULARITY_ROOTFS}/app

    # Create mount point for the uv cache (will be used if --bind is specified)
    mkdir -p ${SINGULARITY_ROOTFS}/root/.cache/uv

%post
    export UV_COMPILE_BYTECODE=1
    export UV_LINK_MODE=copy
    export UV_NO_EDITABLE=1
    export UV_FROZEN=1
    cd /app
    uv sync --no-dev

Bootstrap: docker
From: python:3.12-slim-bookworm
Stage: final

%arguments
    MODEL_NAMES=""

%setup
    mkdir -p ${SINGULARITY_ROOTFS}/app/models
    MODEL_NAMES={{ MODEL_NAMES }}

    if [[ -n "${MODEL_NAMES}" ]]; then
        for model in ${MODEL_NAMES}; do
            if [ ! -d "models/${model}" ]; then
                echo "Requested model directory models/${model} was not found" >&2
                exit 1
            fi
            rsync -av "models/${model}/" "${SINGULARITY_ROOTFS}/app/models/${model}/"
        done
    else
        echo "No models were copied into the image. Use --build-arg MODEL_NAMES=\"name1 name2\"" >&2
        exit 1
    fi

    # Create mount point for the uv cache
    # (not used in final stage, but needed for --bind to work)
    mkdir -p ${SINGULARITY_ROOTFS}/root/.cache/uv

%files from builder
    /app /app

%post
    apt-get update && apt-get install -y --no-install-recommends \
        build-essential \
        && rm -rf /var/lib/apt/lists/*

    chmod -R a+rX /app
    find /app -type f -name "*.py" -exec chmod a+r {} \;

%environment
    export PATH="/app/.venv/bin:$PATH"

%runscript
    cd /app
    python3 main.py "$@"
